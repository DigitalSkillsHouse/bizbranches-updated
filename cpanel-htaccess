RewriteEngine On

# ─── Redirect legacy /business/slug → /slug (permanent) ───
RewriteRule ^business/(.+)$ /$1 [R=301,L]

# ─── Serve /api/* requests via PHP ───
RewriteCond %{REQUEST_URI} ^/api(/.*)?$
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^api(/.*)?$ api/index.php [QSA,L]

# ─── Serve static Next.js assets directly ───
RewriteCond %{REQUEST_URI} ^/_next/
RewriteRule ^ - [L]

# ─── Serve existing files directly (images, manifest, robots.txt, etc.) ───
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# ─── Serve existing directories (check for index.html inside) ───
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_FILENAME}/index.html -f
RewriteRule ^(.*)/?$ $1/index.html [L]

# ─── Try .html extension for clean URLs (e.g. /about → about.html) ───
RewriteCond %{REQUEST_FILENAME}.html -f
RewriteRule ^(.*)$ $1.html [L]

# ─── Fallback: serve _placeholder.html (business detail SPA shell) for unknown slugs ───
# _placeholder.html is generated by [slug]/page.tsx and contains the BusinessDetailPage
# component which reads the slug from the URL and fetches data client-side from /api/.
# This lets all 4000+ business pages work without needing to pre-render each one.
RewriteCond %{DOCUMENT_ROOT}/_placeholder.html -f
RewriteRule ^ _placeholder.html [L]

# ─── Ultimate fallback: index.html for any other route ───
RewriteRule ^ index.html [L]

# ─── Make index.html the default document ───
DirectoryIndex index.html

# ─── Security: block access to sensitive files ───
<FilesMatch "^\.env|\.gitignore$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ─── Gzip compression ───
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css application/json
    AddOutputFilterByType DEFLATE application/javascript text/javascript
</IfModule>

# ─── Browser caching for static assets ───
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>
